<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Edit Unit | Master Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { font-family: 'Montserrat', sans-serif; background: #060F1A; color: white; padding: 20px 20px 100px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-size: 10px; font-weight: 800; color: #7A9BB5; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 1.5px; }
    input, select, textarea { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 16px; color: white; font-size: 14px; outline: none; transition: 0.3s; }
    input:focus, select:focus { border-color: #C9A84C; background: rgba(255,255,255,0.08); }
    .save-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #060F1A; border-top: 1px solid rgba(255,255,255,0.1); padding: 20px; z-index: 1000; }
  </style>
</head>
<body>
  <div class="flex items-center gap-4 mb-8 mt-4">
    <button onclick="location.href='dashboard.html'" class="bg-white/5 w-10 h-10 rounded-full flex items-center justify-center text-slate-400"><i class="fas fa-arrow-left"></i></button>
    <h1 id="pageTitle" class="text-xl font-800 uppercase text-[#C9A84C]">Add New Unit</h1>
  </div>

  <form id="propForm" onsubmit="save(event)">
    <div class="grid grid-cols-2 gap-4">
      <div class="form-group"><label>HP-ID (Required)</label><input type="text" id="HP_ID" required placeholder="HP00-XXXX"></div>
      <div class="form-group"><label>Plot Number</label><input type="text" id="Plot"></div>
    </div>

    <div class="form-group"><label>Project Name</label><select id="Project_Name" required></select></div>

    <div class="grid grid-cols-2 gap-4">
      <div class="form-group"><label>Status</label><select id="Status"></select></div>
      <div class="form-group"><label>Furnishing</label><select id="Furnishing"></select></div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div class="form-group"><label>Listing Type</label><select id="Listing_Type"></select></div>
      <div class="form-group"><label>Bedrooms</label><input type="number" id="Bedrooms"></div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div class="form-group"><label>Sale Price (฿)</label><input type="number" id="Sale_Price"></div>
      <div class="form-group"><label>Monthly Rent (฿)</label><input type="number" id="Monthly_Rent"></div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div class="form-group"><label>District</label><select id="District"></select></div>
      <div class="form-group"><label>Zone</label><select id="Zone"></select></div>
    </div>

    <div class="form-group"><label>Thumbnail URL</label><input type="text" id="Thumbnail_Image"></div>
    <div class="form-group"><label>Album URLs (Comma separated)</label><textarea id="Album_Image" rows="2"></textarea></div>
    <div class="form-group"><label>Description</label><textarea id="Description" rows="4"></textarea></div>

    <div class="save-bar">
      <button type="submit" id="saveBtn" class="bg-[#C9A84C] text-[#060F1A] w-full py-4 rounded-xl font-800 uppercase tracking-widest shadow-2xl">Save Property</button>
    </div>
  </form>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbyOnZc6s05eGvHR5XmRnRPAat8vNZpf8cFhL2GiAFjWld-2OBf2OqgP07RU07UTZgDXxA/exec";
    const id = new URLSearchParams(window.location.search).get('id');

    async function init() {
      // 1. Fetch Metadata for Dropdowns
      const metaRes = await fetch(`${API}?mode=getMetadata`);
      const meta = (await metaRes.json()).data;
      
      const fields = ["Project_Name", "Status", "Furnishing", "Listing_Type", "District", "Zone"];
      fields.forEach(f => {
        const el = document.getElementById(f);
        if(el && meta[f]) el.innerHTML = meta[f].map(v => `<option value="${v}">${v}</option>`).join('');
      });

      // 2. Load Unit Data if Editing
      if (id) {
        document.getElementById('pageTitle').innerText = 'Edit Unit: ' + id;
        document.getElementById('HP_ID').readOnly = true;
        const res = await fetch(`${API}?mode=getUnitDetail&id=${id}`);
        const u = (await res.json()).data;
        Object.keys(u).forEach(key => {
          const el = document.getElementById(key);
          if(el) el.value = u[key];
        });
      }
    }

    async function save(e) {
      e.preventDefault();
      const btn = document.getElementById('saveBtn');
      btn.innerText = 'SAVING...'; btn.disabled = true;
      
      const payload = {};
      const inputs = document.querySelectorAll('input, select, textarea');
      inputs.forEach(el => { if(el.id) payload[el.id] = el.value; });

      try {
        const res = await fetch(API, { method: 'POST', body: JSON.stringify(payload) });
        const result = await res.json();
        if(result.ok) { alert('Unit Saved Successfully!'); location.href = 'dashboard.html'; }
      } catch (err) { alert('Error saving: ' + err); btn.innerText = 'SAVE PROPERTY'; btn.disabled = false; }
    }
    window.onload = init;
  </script>
</body>
</html>
